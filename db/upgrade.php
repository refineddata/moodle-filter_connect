<?php
/**
 * Manual authentication plugin upgrade code
 *
 * @package    filter
 * @subpackage connect
 * @copyright  2012 Gary Menezes, RefinedData Solutions Inc
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

/**
 * @param int $oldversion the version we are upgrading from
 * @return bool result
 */
function xmldb_filter_connect_upgrade($oldversion) {
    global $CFG, $DB, $OUTPUT;

    if ($oldversion < 2011100802) {
        $dbman = $DB->get_manager();

        // Add Cache Table
        $table = new xmldb_table('connect_cache');
        $table->add_field('id', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
        $table->add_field('ctype', XMLDB_TYPE_CHAR, '10', null, XMLDB_NOTNULL, null, '');
        $table->add_field('ckey', XMLDB_TYPE_CHAR, '100', null, XMLDB_NOTNULL, null, '');
        $table->add_field('ctime', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
        $table->add_field('cdata', XMLDB_TYPE_TEXT, 'big', null, XMLDB_NOTNULL, null, null);

        // Keys & Indexes
        $table->add_key('primary', XMLDB_KEY_PRIMARY, array('id'));
        $table->add_index('type-key', XMLDB_INDEX_NOTUNIQUE, array('type', 'key'));

        if (!$dbman->table_exists($table)) $dbman->create_table($table);

        upgrade_plugin_savepoint(true, 2011100802, 'filter', 'connect');
    }

    // Moodle v2.1.0 release upgrade line
    // Put any upgrade step following this

    if ($oldversion < 20130080900) {

        $table = 'user_info_field';

        $conditions = array('shortname' => 'aclogin');
        $record_exists = $DB->record_exists($table, $conditions);
        if ($record_exists) $DB->delete_records($table, $conditions);

        $conditions = array('shortname' => 'ackey');
        $record_exists = $DB->record_exists($table, $conditions);
        if ($record_exists) $DB->delete_records($table, $conditions);
    }

    if( $oldversion < 2015061000 ){
        $insert_timezones = array(
array('(+ 0 WET) Western European Time','0','85'),
array('(+ 1 CET) Central European Time','60','110'),
array('(+ 2 EET) Eastern European Time','120','130'),
array('(- 3.5 NST) Newfoundland Standard Time','-210','60'),
array('(- 4 AST) Atlantic Standard Time','-240','50'),
array('(- 5 EST) Eastern Standard Time','-300','35'),
array('(- 6 CST) Central Standard Time','-360','20'),
array('(- 7 MST) Mountain Standard Time','-420','10'),
array('(- 8 PST) Pacific Standard Time','-490','4'),
array('(- 9 AKST) Alaska Standard Time','-540','3'),
array('(-11 HST) Hawaii Standard Time','-660','2'),
array('-0.5','-30','83'),
array('-1.0','-60','80'),
array('-1.5','-90','75'),
array('-10.0','-600','2'),
array('-10.5','-630','1'),
array('-11.0','-660','1'),
array('-11.5','-690','0'),
array('-12.0','-720','0'),
array('-12.5','-750','0'),
array('-13.0','-780','0'),
array('-2.0','-120','75'),
array('-2.5','-150','75'),
array('-3.0','-180','65'),
array('-3.5','-210','60'),
array('-4.0','-240','50'),
array('-4.5','-270','55'),
array('-5.0','-300','35'),
array('-5.5','-330','35'),
array('-6.0','-360','20'),
array('-6.5','-390','20'),
array('-7.0','-420','10'),
array('-7.5','-450','4'),
array('-8.0','-480','4'),
array('-8.5','-510','3'),
array('-9.0','-540','3'),
array('-9.5','-570','2'),
array('0.0','0','85'),
array('0.5','30','85'),
array('1.0','60','110'),
array('1.5','90','110'),
array('10.0','600','255'),
array('10.5','630','275'),
array('11.0','660','280'),
array('11.5','690','280'),
array('12.0','720','290'),
array('12.5','750','290'),
array('13.0','780','300'),
array('2.0','120','130'),
array('2.5','150','130'),
array('3.0','180','145'),
array('3.5','210','160'),
array('4.0','240','165'),
array('4.5','270','175'),
array('5.0','300','180'),
array('5.5','330','190'),
array('6.0','360','200'),
array('6.5','390','203'),
array('7.0','420','205'),
array('7.5','450','205'),
array('8.0','480','210'),
array('8.5','510','210'),
array('9.0','540','230'),
array('9.5','570','250'),
array('Africa/Abidjan','0','85'),
array('Africa/Accra','0','85'),
array('Africa/Addis_Ababa','180','155'),
array('Africa/Algiers','60','113'),
array('Africa/Asmara','180','155'),
array('Africa/Bamako','0','85'),
array('Africa/Bangui','60','113'),
array('Africa/Banjul','0','85'),
array('Africa/Bissau','0','85'),
array('Africa/Blantyre','120','140'),
array('Africa/Brazzaville','60','113'),
array('Africa/Bujumbura','120','140'),
array('Africa/Cairo','120','135'),
array('Africa/Casablanca','0','90'),
array('Africa/Ceuta','60','113'),
array('Africa/Conakry','0','85'),
array('Africa/Dakar','0','85'),
array('Africa/Dar_es_Salaam','180','155'),
array('Africa/Djibouti','180','155'),
array('Africa/Douala','60','113'),
array('Africa/El_Aaiun','0','85'),
array('Africa/Freetown','0','85'),
array('Africa/Gaborone','120','140'),
array('Africa/Harare','120','140'),
array('Africa/Johannesburg','120','140'),
array('Africa/Kampala','180','155'),
array('Africa/Khartoum','180','155'),
array('Africa/Kigali','120','140'),
array('Africa/Kinshasa','60','113'),
array('Africa/Lagos','60','113'),
array('Africa/Libreville','60','113'),
array('Africa/Lome','0','85'),
array('Africa/Luanda','60','113'),
array('Africa/Lubumbashi','120','140'),
array('Africa/Lusaka','120','140'),
array('Africa/Malabo','60','113'),
array('Africa/Maputo','120','140'),
array('Africa/Maseru','120','140'),
array('Africa/Mbabane','120','140'),
array('Africa/Mogadishu','180','155'),
array('Africa/Monrovia','0','90'),
array('Africa/Nairobi','180','155'),
array('Africa/Ndjamena','60','113'),
array('Africa/Niamey','60','113'),
array('Africa/Nouakchott','0','85'),
array('Africa/Ouagadougou','0','85'),
array('Africa/Porto-Novo','60','113'),
array('Africa/Sao_Tome','0','85'),
array('Africa/Tripoli','120','140'),
array('Africa/Tunis','60','113'),
array('Africa/Windhoek','60','113'),
array('America/Adak','-600','2'),
array('America/Anchorage','-540','3'),
array('America/Anguilla','-240','55'),
array('America/Antigua','-240','55'),
array('America/Araguaina','-180','65'),
array('America/Argentina/Buenos_Aires','-180','70'),
array('America/Argentina/Catamarca','-180','70'),
array('America/Argentina/Cordoba','-180','70'),
array('America/Argentina/Jujuy','-180','70'),
array('America/Argentina/La_Rioja','-180','70'),
array('America/Argentina/Mendoza','-180','70'),
array('America/Argentina/Rio_Gallegos','-180','70'),
array('America/Argentina/San_Juan','-180','70'),
array('America/Argentina/San_Luis','-180','70'),
array('America/Argentina/Tucuman','-180','70'),
array('America/Argentina/Ushuaia','-180','70'),
array('America/Aruba','-240','55'),
array('America/Asuncion','-240','55'),
array('America/Atikokan','-300','35'),
array('America/Bahia','-180','65'),
array('America/Barbados','-240','55'),
array('America/Belem','-180','65'),
array('America/Belize','-360','33'),
array('America/Blanc-Sablon','-240','55'),
array('America/Boa_Vista','-240','55'),
array('America/Bogota','-300','45'),
array('America/Boise','-420','10'),
array('America/Cambridge_Bay','-420','10'),
array('America/Campo_Grande','-240','55'),
array('America/Cancun','-360','33'),
array('America/Caracas','-270','55'),
array('America/Cayenne','-180','65'),
array('America/Cayman','-300','45'),
array('America/Chicago','-360','20'),
array('America/Chihuahua','-420','13'),
array('America/Costa_Rica','-360','33'),
array('America/Cuiaba','-240','55'),
array('America/Curacao','-240','55'),
array('America/Danmarkshavn','0','85'),
array('America/Dawson','-480','4'),
array('America/Dawson_Creek','-420','10'),
array('America/Denver','-420','10'),
array('America/Detroit','-300','35'),
array('America/Dominica','-240','55'),
array('America/Edmonton','-420','10'),
array('America/Eirunepe','-300','45'),
array('America/El_Salvador','-360','33'),
array('America/Fortaleza','-180','65'),
array('America/Glace_Bay','-240','50'),
array('America/Godthab','-180','65'),
array('America/Goose_Bay','-240','50'),
array('America/Grand_Turk','-300','45'),
array('America/Grenada','-240','55'),
array('America/Guadeloupe','-240','55'),
array('America/Guatemala','-360','33'),
array('America/Guayaquil','-300','45'),
array('America/Guyana','-240','55'),
array('America/Halifax','-240','50'),
array('America/Havana','-300','45'),
array('America/Hermosillo','-420','15'),
array('America/Indiana/Indianapolis','-300','40'),
array('America/Indiana/Knox','-360','20'),
array('America/Indiana/Marengo','-300','40'),
array('America/Indiana/Petersburg','-300','40'),
array('America/Indiana/Tell_City','-360','20'),
array('America/Indiana/Vevay','-300','40'),
array('America/Indiana/Vincennes','-300','40'),
array('America/Indiana/Winamac','-300','40'),
array('America/Inuvik','-420','10'),
array('America/Iqaluit','-300','35'),
array('America/Jamaica','-300','45'),
array('America/Juneau','-540','3'),
array('America/Kentucky/Louisville','-300','35'),
array('America/Kentucky/Monticello','-300','35'),
array('America/La_Paz','-240','55'),
array('America/Lima','-300','35'),
array('America/Los_Angeles','-480','4'),
array('America/Maceio','-180','65'),
array('America/Managua','-360','33'),
array('America/Manaus','-240','55'),
array('America/Martinique','-240','55'),
array('America/Mazatlan','-420','10'),
array('America/Menominee','-360','20'),
array('America/Merida','-360','33'),
array('America/Mexico_City','-360','33'),
array('America/Miquelon','-180','73'),
array('America/Moncton','-240','50'),
array('America/Monterrey','-360','30'),
array('America/Montevideo','-180','65'),
array('America/Montreal','-300','35'),
array('America/Montserrat','-240','55'),
array('America/Nassau','-300','45'),
array('America/New_York','-300','35'),
array('America/Nipigon','-300','35'),
array('America/Nome','-540','3'),
array('America/Noronha','-120','75'),
array('America/North_Dakota/Center','-360','20'),
array('America/North_Dakota/New_Salem','-360','20'),
array('America/Panama','-300','45'),
array('America/Pangnirtung','-300','45'),
array('America/Paramaribo','-180','65'),
array('America/Phoenix','-420','15'),
array('America/Port-au-Prince','-300','45'),
array('America/Porto_Velho','-240','55'),
array('America/Port_of_Spain','-240','55'),
array('America/Puerto_Rico','-240','55'),
array('America/Rainy_River','-360','25'),
array('America/Rankin_Inlet','-360','20'),
array('America/Recife','-180','65'),
array('America/Regina','-360','25'),
array('America/Resolute','-300','35'),
array('America/Rio_Branco','-300','45'),
array('America/Santiago','-240','56'),
array('America/Santo_Domingo','-240','55'),
array('America/Sao_Paulo','-180','65'),
array('America/Scoresbysund','-60','83'),
array('America/St_Johns','-210','60'),
array('America/St_Kitts','-240','55'),
array('America/St_Lucia','-240','55'),
array('America/St_Thomas','-240','55'),
array('America/St_Vincent','-240','55'),
array('America/Swift_Current','-360','25'),
array('America/Tegucigalpa','-360','33'),
array('America/Thule','-240','55'),
array('America/Thunder_Bay','-300','35'),
array('America/Tijuana','-480','4'),
array('America/Toronto','-300','35'),
array('America/Tortola','-240','56'),
array('America/Vancouver','-480','4'),
array('America/Whitehorse','-480','4'),
array('America/Winnipeg','-360','25'),
array('America/Yakutat','-540','3'),
array('America/Yellowknife','-420','10'),
array('Antarctica/Casey','480','225'),
array('Antarctica/Davis','420','205'),
array('Antarctica/DumontDUrville','600','255'),
array('Antarctica/Mawson','360','200'),
array('Antarctica/McMurdo','720','290'),
array('Antarctica/Palmer','-240','55'),
array('Antarctica/Rothera','-180','65'),
array('Antarctica/Syowa','180','145'),
array('Antarctica/Vostok','360','200'),
array('Asia/Aden','180','150'),
array('Asia/Almaty','360','201'),
array('Asia/Amman','120','135'),
array('Asia/Anadyr','720','285'),
array('Asia/Aqtau','300','180'),
array('Asia/Aqtobe','300','180'),
array('Asia/Ashgabat','300','180'),
array('Asia/Baghdad','180','158'),
array('Asia/Bahrain','180','150'),
array('Asia/Baku','240','170'),
array('Asia/Bangkok','420','205'),
array('Asia/Beirut','120','135'),
array('Asia/Bishkek','360','201'),
array('Asia/Brunei','480','215'),
array('Asia/Choibalsan','480','215'),
array('Asia/Chongqing','480','210'),
array('Asia/Colombo','330','190'),
array('Asia/Damascus','120','135'),
array('Asia/Dhaka','360','195'),
array('Asia/Dili','540','230'),
array('Asia/Dubai','240','165'),
array('Asia/Dushanbe','300','180'),
array('Asia/Gaza','120','135'),
array('Asia/Harbin','480','210'),
array('Asia/Hong_Kong','480','210'),
array('Asia/Hovd','420','207'),
array('Asia/Ho_Chi_Minh','420','205'),
array('Asia/Irkutsk','480','227'),
array('Asia/Jakarta','420','205'),
array('Asia/Jayapura','540','235'),
array('Asia/Jerusalem','120','135'),
array('Asia/Kabul','270','175'),
array('Asia/Kamchatka','720','285'),
array('Asia/Karachi','300','185'),
array('Asia/Kashgar','480','227'),
array('Asia/Katmandu','345','193'),
array('Asia/Kolkata','330','190'),
array('Asia/Krasnoyarsk','420','207'),
array('Asia/Kuala_Lumpur','480','215'),
array('Asia/Kuching','480','210'),
array('Asia/Kuwait','180','150'),
array('Asia/Macau','480','215'),
array('Asia/Magadan','660','280'),
array('Asia/Makassar','480','215'),
array('Asia/Manila','480','210'),
array('Asia/Muscat','240','165'),
array('Asia/Nicosia','120','140'),
array('Asia/Novosibirsk','360','201'),
array('Asia/Omsk','360','201'),
array('Asia/Oral','300','180'),
array('Asia/Phnom_Penh','420','205'),
array('Asia/Pontianak','420','207'),
array('Asia/Pyongyang','540','230'),
array('Asia/Qatar','180','150'),
array('Asia/Qyzylorda','360','200'),
array('Asia/Rangoon','390','203'),
array('Asia/Riyadh','180','150'),
array('Asia/Sakhalin','600','275'),
array('Asia/Samarkand','300','180'),
array('Asia/Seoul','540','230'),
array('Asia/Shanghai','480','210'),
array('Asia/Singapore','480','215'),
array('Asia/Taipei','480','220'),
array('Asia/Tashkent','300','185'),
array('Asia/Tbilisi','240','170'),
array('Asia/Tehran','210','160'),
array('Asia/Thimphu','360','200'),
array('Asia/Tokyo','540','235'),
array('Asia/Ulaanbaatar','480','227'),
array('Asia/Urumqi','480','210'),
array('Asia/Vientiane','420','205'),
array('Asia/Vladivostok','600','270'),
array('Asia/Yakutsk','540','240'),
array('Asia/Yekaterinburg','300','180'),
array('Asia/Yerevan','240','170'),
array('Atlantic/Azores','-60','80'),
array('Atlantic/Bermuda','-240','50'),
array('Atlantic/Canary','0','85'),
array('Atlantic/Cape_Verde','-60','83'),
array('Atlantic/Faroe','0','85'),
array('Atlantic/Madeira','0','85'),
array('Atlantic/Reykjavik','0','85'),
array('Atlantic/South_Georgia','-120','75'),
array('Atlantic/Stanley','-240','50'),
array('Atlantic/St_Helena','0','85'),
array('Australia/Adelaide','570','250'),
array('Australia/Brisbane','600','260'),
array('Australia/Broken_Hill','570','250'),
array('Australia/Currie','600','260'),
array('Australia/Darwin','570','245'),
array('Australia/Eucla','525','225'),
array('Australia/Hobart','600','265'),
array('Australia/Lindeman','600','255'),
array('Australia/Lord_Howe','630','260'),
array('Australia/Melbourne','600','255'),
array('Australia/Perth','480','225'),
array('Australia/Sydney','600','255'),
array('CET','60','110'),
array('CST6CDT','-360','20'),
array('EET','120','130'),
array('EST','-300','35'),
array('EST5EDT','-300','35'),
array('Europe/Amsterdam','60','110'),
array('Europe/Andorra','60','105'),
array('Europe/Athens','120','130'),
array('Europe/Belgrade','60','95'),
array('Europe/Berlin','60','110'),
array('Europe/Brussels','60','105'),
array('Europe/Bucharest','120','115'),
array('Europe/Budapest','60','95'),
array('Europe/Chisinau','120','125'),
array('Europe/Copenhagen','60','110'),
array('Europe/Dublin','0','85'),
array('Europe/Gibraltar','60','105'),
array('Europe/Helsinki','120','125'),
array('Europe/Istanbul','120','130'),
array('Europe/Kaliningrad','120','125'),
array('Europe/Kiev','120','125'),
array('Europe/Lisbon','0','85'),
array('Europe/London','0','85'),
array('Europe/Luxembourg','60','110'),
array('Europe/Madrid','60','105'),
array('Europe/Malta','60','110'),
array('Europe/Minsk','120','130'),
array('Europe/Monaco','60','110'),
array('Europe/Moscow','180','145'),
array('Europe/Oslo','60','105'),
array('Europe/Paris','60','105'),
array('Europe/Prague','60','95'),
array('Europe/Riga','120','125'),
array('Europe/Rome','60','110'),
array('Europe/Samara','240','170'),
array('Europe/Simferopol','120','125'),
array('Europe/Sofia','120','125'),
array('Europe/Stockholm','60','110'),
array('Europe/Tallinn','120','125'),
array('Europe/Tirane','60','110'),
array('Europe/Uzhgorod','120','125'),
array('Europe/Vaduz','60','105'),
array('Europe/Vienna','60','110'),
array('Europe/Vilnius','120','125'),
array('Europe/Volgograd','180','145'),
array('Europe/Warsaw','60','100'),
array('Europe/Zaporozhye','120','125'),
array('Europe/Zurich','60','110'),
array('HST','-600','2'),
array('Indian/Antananarivo','180','150'),
array('Indian/Chagos','360','200'),
array('Indian/Christmas','420','205'),
array('Indian/Cocos','390','203'),
array('Indian/Comoro','180','150'),
array('Indian/Kerguelen','300','180'),
array('Indian/Mahe','240','170'),
array('Indian/Maldives','300','180'),
array('Indian/Mauritius','240','170'),
array('Indian/Mayotte','180','150'),
array('Indian/Reunion','240','170'),
array('MET','60','95'),
array('MST','-420','10'),
array('MST7MDT','-420','10'),
array('Pacific/Apia','-660','1'),
array('Pacific/Auckland','720','290'),
array('Pacific/Chatham','765','300'),
array('Pacific/Easter','-360','33'),
array('Pacific/Efate','660','280'),
array('Pacific/Enderbury','780','300'),
array('Pacific/Fakaofo','-600','2'),
array('Pacific/Fiji','720','285'),
array('Pacific/Funafuti','720','285'),
array('Pacific/Galapagos','-360','33'),
array('Pacific/Gambier','-540','3'),
array('Pacific/Guadalcanal','660','280'),
array('Pacific/Guam','600','275'),
array('Pacific/Honolulu','-600','2'),
array('Pacific/Johnston','-600','2'),
array('Pacific/Kiritimati','840','300'),
array('Pacific/Kosrae','660','280'),
array('Pacific/Kwajalein','720','285'),
array('Pacific/Majuro','720','285'),
array('Pacific/Marquesas','-570','2'),
array('Pacific/Midway','-660','1'),
array('Pacific/Nauru','720','285'),
array('Pacific/Niue','-660','1'),
array('Pacific/Norfolk','690','280'),
array('Pacific/Noumea','660','280'),
array('Pacific/Pago_Pago','-660','1'),
array('Pacific/Palau','540','230'),
array('Pacific/Pitcairn','-480','4'),
array('Pacific/Ponape','660','280'),
array('Pacific/Port_Moresby','600','275'),
array('Pacific/Rarotonga','-600','2'),
array('Pacific/Saipan','600','275'),
array('Pacific/Tahiti','-600','2'),
array('Pacific/Tarawa','720','285'),
array('Pacific/Tongatapu','780','300'),
array('Pacific/Truk','600','270'),
array('Pacific/Wake','720','285'),
array('Pacific/Wallis','720','285'),
array('PST8PDT','-480','4'),
array('WET','0','85')
        );

        foreach( $insert_timezones as $timezone ){
            $check = $DB->get_record( 'connect_timezones', array( 'name' => $timezone[0] ), '*', IGNORE_MULTIPLE );
            if( !$check ){
                $r = new stdClass();
                $r->name = $timezone[0];
                $r->gmtoff = $timezone[1];
                $r->connect_timezone = $timezone[2];
                $DB->insert_record( 'connect_timezones', $r );
            }
        }
    }

    return true;
}
